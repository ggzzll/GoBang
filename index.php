<?php
//Copyright © 2022 GGZZLL All rights reserved.
function Curl($Url){
		$Curl=curl_init();
		curl_setopt($Curl,CURLOPT_URL,$Url);
		curl_setopt($Curl,CURLOPT_TIMEOUT,10);
		curl_setopt($Curl,CURLOPT_SSL_VERIFYPEER,0);
		curl_setopt($Curl,CURLOPT_RETURNTRANSFER,1);
		return curl_exec($Curl);
		curl_close($Curl);
}
//发请求
session_start();
$Bg = imagecreatefrompng("img/Bg.png");
$Im = @imagecreatetruecolor(imagesx($Bg), imagesy($Bg)+200);
$White = imagecolorallocate($Im, 255, 255, 255);
imagefill($Im, 0, 0, $White);
@imagecopy($Im, $Bg, 0, 0, 0, 0, imagesx($Bg), imagesy($Bg));
$USRID = $_GET["id"];
$User = $_SESSION["User"];
$Font = "./song.ttf";
$Black = imagecolorallocate($Im, 0, 0, 0);
if ($USRID){
		if (!$User["Black"]){
				$User["Black"]=$USRID;
				$User["Rounds"]=$USRID;
				imagefttext($Im, 60, 0, 251, 1040, $Black, $Font, "加入成功");
		}else if (!$User["White"] && $User["Black"]!==$USRID){
				$User["White"]=$USRID;
				imagefttext($Im, 60, 0, 251, 1040, $Black, $Font, "加入成功");
		}
}
//加入
$Out = $_GET["out"];
$Qi = $_SESSION["Qi"];
if ($Out){
		if ($Out==$User["Black"] && !$User["White"]){
				$User["Black"]="";
				$Qi=[];
				imagefttext($Im, 60, 0, 251, 1040, $Black, $Font, "退出成功");
		}else if ($Out==$User["Black"] && $User["White"]){
				$User["Rounds"]=$User["White"];
				$User["Black"]=$User["White"];
				$User["White"]="";
				$Qi=[];
				imagefttext($Im, 60, 0, 251, 1040, $Black, $Font, "退出成功");
		}else if ($Out==$User["White"]){
				$User["White"]="";
				$Qi=[];
				imagefttext($Im, 60, 0, 251, 1040, $Black, $Font, "退出成功");
		}else imagefttext($Im, 60, 0, 251, 1040, $Black, $Font, "退出失败");
}
//退出
$X = $_GET["x"];
$Y = $_GET["y"];
if ($User["Black"] && $User["White"] && $USRID){
		if (!$Qi) for ($A=1; $A<=15; $A++) for ($B=1; $B<=15; $B++) $Qi[$A.",".$B]="?";
		//初始化
		$QI=($User["Black"]==$USRID)?"Black":(($User["White"]==$USRID)?"White":"");
		if ($QI && $User["Rounds"]==$USRID){
				if ($Qi[$Y.",".$X]=="?"){
						$Qi[$Y.",".$X]=$QI;
						imagefttext($Im, 60, 0, 251, 1040, $Black, $Font, "下棋成功");
						$User["Rounds"]=($User["Rounds"]==$User["Black"])?$User["White"]:$User["Black"];
				}
				//下棋
				if ($Qi[$Y.",".$X]==$QI){
						for ($A=0; $A<=$A+1; $A++) if (!$Qi[($Y-$A).",".$X] || $Qi[($Y-$A).",".$X]=="?" || $Qi[($Y-$A).",".$X]!==$QI) break;
						for ($B=0; $B<=$B+1; $B++) if (!$Qi[($Y-$A+$B).",".$X] || $Qi[($Y-$A+$B).",".$X]=="?" || $Qi[($Y-$A+$B).",".$X]!==$QI) break;
						//上下
						for ($C=0; $C<=$C+1; $C++) if (!$Qi[$Y.",".($X-$C)] || $Qi[$Y.",".($X-$C)]=="?" || $Qi[$Y.",".($X-$C)]!==$QI) break;
						for ($D=0; $D<=$D+1; $D++) if (!$Qi[$Y.",".($X-$C+$D)] || $Qi[$Y.",".($X-$C+$D)]=="?" || $Qi[$Y.",".($X-$C+$D)]!==$QI) break;
						//左右
						for ($E=0; $E<=$E+1; $E++) if (!$Qi[($Y-$E).",".($X-$E)] || $Qi[($Y-$E).",".($X-$E)]=="?" || $Qi[($Y-$E).",".($X-$E)]!==$QI) break;
						for ($F=0; $F<=$F+1; $F++) if (!$Qi[($Y-$E+$F).",".($X-$E+$F)] || $Qi[($Y-$E+$F).",".($X-$E+$F)]=="?" || $Qi[($Y-$E+$F).",".($X-$E+$F)]!==$QI) break;
						//左斜\
						for ($G=0; $G<=$G+1; $G++) if (!$Qi[($Y-$G).",".($X+$G)] || $Qi[($Y-$G).",".($X+$G)]=="?" || $Qi[($Y-$G).",".($X+$G)]!==$QI) break;
						for ($H=0; $H<=$H+1; $H++) if (!$Qi[($Y-$G+$H).",".($X+$G-$H)] || $Qi[($Y-$G+$H).",".($X+$G-$H)]=="?" || $Qi[($Y-$G+$H).",".($X+$G-$H)]!==$QI) break;
						//右斜/
						if ($A>=5 || $B>=5 || $C>=5 || $D>=5 || $E>=5 || $F>=5 || $G>=5 || $H>=5){
								$Bg = @imagecreatetruecolor(500, 150);
								imagefill($Bg, 0, 0, $White);
								@imagecopy($Im, $Bg, 250, 950, 0, 0, 500, 150);
								imagefttext($Im, 60, 0, 251, 1040, $Black, $Font, "恭喜胜利");
								session_destroy();
						}
						//胜利
						for ($A=1; $A<=15; $A++) for ($B=1; $B<=15; $B++){
								if ($Qi[$A.",".$B]=="?") break;
								if ($A.$B=="1515"){
										$Bg = @imagecreatetruecolor(500, 150);
										imagefill($Bg, 0, 0, $White);
										@imagecopy($Im, $Bg, 250, 950, 0, 0, 500, 150);
										imagefttext($Im, 60, 0, 251, 1040, $Black, $Font, "恭喜平局");
										session_destroy();
								}
						}
						//平局
				}
		}
		$Arr = Array("1,1" => [30, 5],"1,2" => [89.5, 5],"1,3" => [149, 5],"1,4" => [208.5, 5],"1,5" => [268, 5],"1,6" => [327.5, 5],"1,7" => [387, 5],"1,8" => [446.5, 5],"1,9" => [506, 5],"1,10" => [565.5, 5],"1,11" => [625, 5],"1,12" => [684.5, 5],"1,13" => [744, 5],"1,14" => [803.5, 5],"1,15" => [863, 5],"2,1" => [30, 68],"2,2" => [89.5, 68],"2,3" => [149, 68],"2,4" => [208.5, 68],"2,5" => [268, 68],"2,6" => [327.5, 68],"2,7" => [387, 68],"2,8" => [446.5, 68],"2,9" => [506, 68],"2,10" => [565.5, 68],"2,11" => [625, 68],"2,12" => [684.5, 68],"2,13" => [744, 68],"2,14" => [803.5, 68],"2,15" => [863, 68],"3,1" => [30, 131],"3,2" => [89.5, 131],"3,3" => [149, 131],"3,4" => [208.5, 131],"3,5" => [268, 131],"3,6" => [327.5, 131],"3,7" => [387, 131],"3,8" => [446.5, 131],"3,9" => [506, 131],"3,10" => [565.5, 131],"3,11" => [625, 131],"3,12" => [684.5, 131],"3,13" => [744, 131],"3,14" => [803.5, 131],"3,15" => [863, 131],"4,1" => [30, 194],"4,2" => [89.5, 194],"4,3" => [149, 194],"4,4" => [208.5, 194],"4,5" => [268, 194],"4,6" => [327.5, 194],"4,7" => [387, 194],"4,8" => [446.5, 194],"4,9" => [506, 194],"4,10" => [565.5, 194],"4,11" => [625, 194],"4,12" => [684.5, 194],"4,13" => [744, 194],"4,14" => [803.5, 194],"4,15" => [863, 194],"5,1" => [30, 257],"5,2" => [89.5, 257],"5,3" => [149, 257],"5,4" => [208.5, 257],"5,5" => [268, 257],"5,6" => [327.5, 257],"5,7" => [387, 257],"5,8" => [446.5, 257],"5,9" => [506, 257],"5,10" => [565.5, 257],"5,11" => [625, 257],"5,12" => [684.5, 257],"5,13" => [744, 257],"5,14" => [803.5, 257],"5,15" => [863, 257],"6,1" => [30, 320],"6,2" => [89.5, 320],"6,3" => [149, 320],"6,4" => [208.5, 320],"6,5" => [268, 320],"6,6" => [327.5, 320],"6,7" => [387, 320],"6,8" => [446.5, 320],"6,9" => [506, 320],"6,10" => [565.5, 320],"6,11" => [625, 320],"6,12" => [684.5, 320],"6,13" => [744, 320],"6,14" => [803.5, 320],"6,15" => [863, 320],"7,1" => [30, 383],"7,2" => [89.5, 383],"7,3" => [149, 383],"7,4" => [208.5, 383],"7,5" => [268, 383],"7,6" => [327.5, 383],"7,7" => [387, 383],"7,8" => [446.5, 383],"7,9" => [506, 383],"7,10" => [565.5, 383],"7,11" => [625, 383],"7,12" => [684.5, 383],"7,13" => [744, 383],"7,14" => [803.5, 383],"7,15" => [863, 383],"8,1" => [30, 446],"8,2" => [89.5, 446],"8,3" => [149, 446],"8,4" => [208.5, 446],"8,5" => [268, 446],"8,6" => [327.5, 446],"8,7" => [387, 446],"8,8" => [446.5, 446],"8,9" => [506, 446],"8,10" => [565.5, 446],"8,11" => [625, 446],"8,12" => [684.5, 446],"8,13" => [744, 446],"8,14" => [803.5, 446],"8,15" => [863, 446],"9,1" => [30, 509],"9,2" => [89.5, 509],"9,3" => [149, 509],"9,4" => [208.5, 509],"9,5" => [268, 509],"9,6" => [327.5, 509],"9,7" => [387, 509],"9,8" => [446.5, 509],"9,9" => [506, 509],"9,10" => [565.5, 509],"9,11" => [625, 509],"9,12" => [684.5, 509],"9,13" => [744, 509],"9,14" => [803.5, 509],"9,15" => [863, 509],"10,1" => [30, 572],"10,2" => [89.5, 572],"10,3" => [149, 572],"10,4" => [208.5, 572],"10,5" => [268, 572],"10,6" => [327.5, 572],"10,7" => [387, 572],"10,8" => [446.5, 572],"10,9" => [506, 572],"10,10" => [565.5, 572],"10,11" => [625, 572],"10,12" => [684.5, 572],"10,13" => [744, 572],"10,14" => [803.5, 572],"10,15" => [863, 572],"11,1" => [30, 635],"11,2" => [89.5, 635],"11,3" => [149, 635],"11,4" => [208.5, 635],"11,5" => [268, 635],"11,6" => [327.5, 635],"11,7" => [387, 635],"11,8" => [446.5, 635],"11,9" => [506, 635],"11,10" => [565.5, 635],"11,11" => [625, 635],"11,12" => [684.5, 635],"11,13" => [744, 635],"11,14" => [803.5, 635],"11,15" => [863, 635],"12,1" => [30, 698],"12,2" => [89.5, 698],"12,3" => [149, 698],"12,4" => [208.5, 698],"12,5" => [268, 698],"12,6" => [327.5, 698],"12,7" => [387, 698],"12,8" => [446.5, 698],"12,9" => [506, 698],"12,10" => [565.5, 698],"12,11" => [625, 698],"12,12" => [684.5, 698],"12,13" => [744, 698],"12,14" => [803.5, 698],"12,15" => [863, 698],"13,1" => [30, 761],"13,2" => [89.5, 761],"13,3" => [149, 761],"13,4" => [208.5, 761],"13,5" => [268, 761],"13,6" => [327.5, 761],"13,7" => [387, 761],"13,8" => [446.5, 761],"13,9" => [506, 761],"13,10" => [565.5, 761],"13,11" => [625, 761],"13,12" => [684.5, 761],"13,13" => [744, 761],"13,14" => [803.5, 761],"13,15" => [863, 761],"14,1" => [30, 824],"14,2" => [89.5, 824],"14,3" => [149, 824],"14,4" => [208.5, 824],"14,5" => [268, 824],"14,6" => [327.5, 824],"14,7" => [387, 824],"14,8" => [446.5, 824],"14,9" => [506, 824],"14,10" => [565.5, 824],"14,11" => [625, 824],"14,12" => [684.5, 824],"14,13" => [744, 824],"14,14" => [803.5, 824],"14,15" => [863, 824],"15,1" => [30, 887],"15,2" => [89.5, 887],"15,3" => [149, 887],"15,4" => [208.5, 887],"15,5" => [268, 887],"15,6" => [327.5, 887],"15,7" => [387, 887],"15,8" => [446.5, 887],"15,9" => [506, 887],"15,10" => [565.5, 887],"15,11" => [625, 887],"15,12" => [684.5, 887],"15,13" => [744, 887],"15,14" => [803.5, 887],"15,15" => [863, 887]);
		foreach ($Arr as $Key => $Value) if ($Qi[$Key]=="Black" || $Qi[$Key]=="White"){
				$Ti = imagecreatefrompng("img/".$Qi[$Key].".png");
				@imagecopy($Im, $Ti, $Value[0], $Value[1], 0, 0, imagesx($Ti), imagesy($Ti));
		}
//显示
}
$Bg = @imagecreatetruecolor(1070, 1520);
imagefill($Bg, 0, 0, $White);
@imagecopy($Bg, $Im, 100, 400, 0, 0, 920, 1120);

$Tx = @imagecreatetruecolor(1000, 250);
imagefill($Tx, 0, 0, $Black);
@imagecopy($Bg, $Tx, 35, 35, 0, 0, 1000, 250);

$TX = @imagecreatetruecolor(970, 220);
imagefill($TX, 0, 0, imagecolorallocate($Bg, 245, 245, 245));
@imagecopy($Bg, $TX, 50, 50, 0, 0, 970, 220);

if ($User["Black"]){
		@imagefttext($Bg, 30, 0, 150, 95, $Black, $Font, "黑方");
		$QiZi = imagecreatefrompng("img/Black.png");
		@imagecopy($Bg, $QiZi, 110, 65, 0, 0, imagesx($QiZi), imagesy($QiZi));
		/*$Curl=Curl('',"","");
		@imagecopy($Bg, imagecreatefromstring($Curl), 100, 110, 0, 0, 140, 140);*/
		//头像
}
if ($User["White"]){
		@imagefttext($Bg, 30, 0, 880, 95, $Black, $Font, "白方");
		$QiZi = imagecreatefrompng("img/White.png");
		@imagecopy($Bg, $QiZi, 840, 65, 0, 0, imagesx($QiZi), imagesy($QiZi));
		/*$Curl=Curl('',"","");
		@imagecopy($Bg, imagecreatefromstring($Curl), 830, 110, 0, 0, 140, 140);*/
		//头像
}
$Fang=($User["Black"]==$USRID)?"白方":(($User["White"]==$USRID)?"黑方":"");
if ($User["Black"] && $User["White"] && $Fang){
		imagefttext($Bg, 30, 0, 455, 200, $Black, $Font, "接下有请");
		imagefttext($Bg, 30, 0, 455, 250, $Black, $Font, $Fang."下棋");
}

for ($A=0; $A<=8; $A++){
		@imagefttext($Bg, 40, 0, 80, 440+(63*$A), $Black, $Font, $A+1);
		@imagefttext($Bg, 40, 0, 130+(60*$A), 380, $Black, $Font, $A+1);
}
for ($A=0; $A<=5; $A++){
		@imagefttext($Bg, 35, 0, 68, 1005+(63*$A), $Black, $Font, 10+$A);
		@imagefttext($Bg, 35, 0, 655+(60*$A), 378, $Black, $Font, 10+$A);
}

imagefttext($Bg, 60, 0, 490, 140, $Black, $Font, "PK");
$_SESSION["Qi"] = $Qi;
$_SESSION["User"] = $User;
header("Content-type: image/png");
imagepng($Bg);